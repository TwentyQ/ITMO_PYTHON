**Лабораторная работа 8. Клиент-серверное приложение на Python с использованием Jinja2**

1.  **Цель работы** 
2.  Создать простое клиент-серверное приложение на Python без серверных фреймворков.
3.  Освоить работу с HTTPServer и маршрутизацию запросов.
4.  Применять шаблонизатор Jinja2 для отображения данных.
5.  Реализовать модели предметной области (User, Currency, UserCurrency, App, Author) с геттерами и сеттерами.
6.  Структурировать код в соответствии с архитектурой MVC.
7.  Получать данные о курсах валют через функцию get_currencies и отображать их пользователям.
8.  Реализовать функциональность подписки пользователей на валюты и отображение динамики их изменения.
9.  Научиться создавать тесты для моделей и серверной логики.
10. **Описание предметной области**

**Модель Currency (Валюта):**

- **id** - уникальный идентификатор валюты (первичный ключ)
- **num_code** - цифровой код валюты (3 цифры)
- **char_code** - символьный код валюты (3 символа)
- **name** - название валюты
- **value** - текущий курс валюты
- **nominal** - номинал валюты

**Модель User (Пользователь):**

- **id** - уникальный идентификатор пользователя (первичный ключ)
- **name** - имя пользователя

**Модель UserCurrency (Связь пользователя с валютой):**

- **id** - уникальный идентификатор связи
- **user_id** - идентификатор пользователя (внешний ключ)
- **currency_id** - идентификатор валюты (внешний ключ)

**Модель Author (Автор приложения):**

- **name** - имя автора
- **group** - учебная группа автора

**Модель App (Приложение):**

- **name** - название приложения
- **version** - версия приложения
- **author** - автор приложения

1.  **Структура проекта**

myapp/

├── models/ # Модели

│ ├──\__init_\_.py # Инициализация моделей

│ ├── app.py # Модель приложения

│ ├── author.py # Модель автора

│ ├── currency.py # Модель валюты

│ ├── user.py # Модель пользователя

│ └── user_currency.py # Модель связи пользователь-валюта

├── templates/ # Шаблоны Jinja2

│ ├── author.html # Страница "Об авторе"

│ ├── currencies.html # Страница со списком валют

│ ├── index.html # Главная страница

│ ├── user.html # Страница пользователя

│ └── users.html # Страница со списком пользователей

├── utils/ # Вспомогательные модули

│ └── currencies_api.py # API для получения курсов валют

├── myapp.py # Основной файл приложения

└── tests # Тесты

1.  **Описание реализации:**

**4.1 Модели и их свойства**

В проекте реализованы 5 основных классов моделей:

- 1.  **App** - модель приложения:
- Приватные поля: \__name, \__version, \__author
- Геттеры/сеттеры с валидацией данных (проверка типов и длины строк)
- Сеттер для author проверяет, что передан объект класса Author
    1.  **Author** - модель автора:
- Приватные поля: \__name, \__group
- Валидация имени (≥2 символа) и группы (>5 символов)
    1.  **Currency** - модель валюты:
- Приватные поля: \__id, \__num_code, \__char_code, \__name, \__value, \__nominal
- Строгая валидация: num_code от 1 до 999, char_code строго 3 символа
    1.  **User** - модель пользователя:
- Приватные поля: \__id, \__name
- Валидация: id > 0, имя ≥ 2 символа
    1.  **UserCurrency** - модель связи пользователей и валют:
- Приватные поля: \__id, \__user_id, \__currency_id
- Валидация: все id ≥ 0

_При невалидных данных выбрасывается ValueError с описанием ошибки._

**4.2 Маршруты и обработка запросов**

**Структура маршрутизации**

Маршрутизация реализована в классе SimpleHTTPRequestHandler через обработку метода do_GET():

**Основные маршруты**

- / - главная страница (template_index)
- /users - страница конкретного пользователя (template_user)
- /user?id=X - страница конкретного пользователя с его валютами
- /currencies - список валют с актуальными курсами (template_currencies)
- /author - информация об авторе (template_author)

**Обработка запросов**

1.  Используется urlparse и parse_qs для извлечения параметров запроса.
2.  Формируется словарь base_data с общими данными для всех страниц.
3.  Проверяется путь и вызывается соответствующий обработчик.
4.  Данные передаются в шаблоны Jinja2.
5.  Результат отправляется клиенту с правильными заголовками.

**4.3 Использование шаблонизатора Jinja2**

**Инициализация Environment**

env = Environment(  
loader=PackageLoader("myapp"),  
autoescape=select_autoescape()  
)

**Компоненты инициализации:**

- PackageLoader("myapp") - загрузчик шаблонов из пакета "myapp"
- select_autoescape() - автоматическое экранирование HTML для безопасности
- Шаблоны загружаются из подкаталога templates/ пакета myapp

**Загрузка шаблонов**

template_index = env.get_template("index.html")  
template_users = env.get_template("users.html")  
template_user = env.get_template("user.html")  
template_currencies = env.get_template("currencies.html")  
template_author = env.get_template("author.html")

**Передача данных в шаблоны**

- Данные передаются через render(\*\*data)
- Шаблоны получают структурированные данные для отображения
- Используется общий контекст base_data для навигации и мета-информации

**4.4 Интеграция функции get_currencies**

Функция get_currencies интегрирована через метод \_update_currency_rates():

1.  Вызов при загрузке страницы /currencies:

- Автоматическое обновление курсов при каждом обращении
- Логирование изменений курсов в консоль

1.  Обработка ошибок:

- Try-except блок для обработки ошибок
- Сообщения об ошибках выводятся в консоль

1.  Обновление данных:

- Получение актуальных курсов из API ЦБ РФ
- Обновление объектов Currency в памяти

1.  **Примеры работы приложения:**

Рисунок 1: Главная страница (/)

Рисунок 2: Страница пользователей (/users)

Рисунок 3: Страница пользователя (/user)

Рисунок 4: Страница курсов валют (/currencies)

Рисунок 5: Страница с информацией об авторе

Рисунок 6: Вывод данных в консоль

1.  **Тестирование:**

**6.1 Примеры тестов**

**1) Тесты моделей**

1\. _Тест корректного изменения имени автора_

def test_name_setter_valid(self):\# Устанавливаем новое имя  
self.author.name = "Новое Имя"  
\# Проверяем, что имя изменилось  
self.assertEqual(self.author.name, "Новое Имя")

_Цель:_ Проверить корректную работу сеттера имени

_Результат:_ Имя успешно изменено на допустимое значение

_2\. Тест некорректного типа данных для имени_

def test_name_setter_invalid_type(self):\# Пытаемся установить имя как число (недопустимый тип)  
with self.assertRaises(ValueError):  
self.author.name = 123

_Цель:_ Проверить валидацию типа данных при установке имени

_Результат:_ Выброшено исключение ValueError при передаче не-строки

_3\. Тест корректного изменения группы автора_

def test_group_setter_valid(self):\# Устанавливаем новую группу длиной 5 символов  
self.author.group = "P3122" # Изменено на длину 5  
\# Проверяем, что группа изменилась  
self.assertEqual(self.author.group, "P3122")

_Цель:_ Проверить корректную работу сеттера группы

_Результат:_ Группа успешно изменена на допустимое значение

Тесты остальных моделей составлены аналогично.

**2) Тестирование функции get_currencies**

_1\. Тест успешного получения курсов валют_

def test_get_currencies_success(self, mock_get):\# Подготовка мок-ответа со всеми запрашиваемыми валютами  
mock_response = Mock()  
mock_response.json.return_value = {  
'Valute': {  
"USD": {"Value": 75.50, "Nominal": 1},  
"EUR": {"Value": 89.25, "Nominal": 1},  
"GBP": {"Value": 105.80, "Nominal": 1}  
}  
}  
mock_response.raise_for_status = Mock()  
mock_get.return_value = mock_response  
<br/>\# Вызов функции  
result = get_currencies(\["USD", "EUR", "GBP"\])  
<br/>\# Assert: Проверка результатов  
self.assertIn("USD", result)  
self.assertIn("EUR", result)  
self.assertIn("GBP", result)  
self.assertEqual(result\["USD"\], 75.50)  
self.assertEqual(result\["EUR"\], 89.25)  
self.assertEqual(result\["GBP"\], 105.80)  
<br/>\# Проверка вызова API  
mock_get.assert_called_once()

_Цель:_ Проверить корректное получение курсов валют из API

_Результат:_ Все запрошенные валюты успешно получены

_2\. Тест отсутствия одной из запрошенных валют_

def test_get_currencies_missing_single_currency(self, mock_get):\# Ответ содержит только USD, но запрашиваются USD и EUR  
mock_response = Mock()  
mock_response.json.return_value = {  
'Valute': {  
"USD": {"Value": 75.50, "Nominal": 1}  
}  
}  
mock_response.raise_for_status = Mock()  
mock_get.return_value = mock_response  
<br/>\# Проверяем, что функция выбрасывает KeyError для EUR  
with self.assertRaises(KeyError) as context:  
get_currencies(\["USD", "EUR"\])  
<br/>\# Дополнительная проверка текста ошибки  
self.assertIn("EUR", str(context.exception))

_Цель:_ Проверить обработку ситуации, когда валюта отсутствует в ответе API

_Результат:_ Выброшено исключение KeyError для отсутствующей валюты

**3) Тесты контроллера**

_1\. Тест обработки главной страницы_

def test_homepage_route(self):\# Симулируем запрос к главной странице  
self.handler.simulate_do_GET('/')  
<br/>\# Проверяем, что был вызван правильный шаблон  
self.handler.template_index.render.assert_called_once()  
self.handler.template_users.render.assert_not_called()  
self.handler.template_user.render.assert_not_called()  
<br/>\# Проверяем, что ответ был записан в wfile  
response = self.handler.wfile.getvalue().decode('utf-8')  
self.assertIn('Главная страница', response)

_Цель:_ Проверить обработку ситуации, когда валюта отсутствует в ответе API

_Результат:_ Выброшено исключение KeyError для отсутствующей валюты

_2\. Тест обработки страницы пользователя с параметром ID_

def test_user_route_with_id(self):\# Симулируем запрос с параметром id  
self.handler.simulate_do_GET('/user?id=1')  
<br/>\# Проверяем вызов шаблона пользователя  
self.handler.template_user.render.assert_called_once()  
<br/>\# Проверяем содержимое ответа  
response = self.handler.wfile.getvalue().decode('utf-8')  
self.assertIn('Страница пользователя', response)

_Цель:_ Проверить обработку query-параметров в URL

_Результат:_ Корректно обработан запрос с параметром id

_3\. Тест логики получения валют пользователя_

def test_user_currency_relationship_logic(self):\# Тест 1: Получение валют для пользователя 1  
user_id = 1  
user_currency_ids = \[  
uc.currency_id  
for uc in self.handler.user_currencies_list  
if uc.user_id == user_id  
\]  
<br/>self.assertEqual(len(user_currency_ids), 2,  
f"У пользователя {user_id} должно быть 2 валюты")  
self.assertIn(1, user_currency_ids, "Должна быть валюта с ID 1 (USD)")  
self.assertIn(2, user_currency_ids, "Должна быть валюта с ID 2 (EUR)")

_Цель:_ Проверить корректность работы связей пользователь-валюта

_Результат:_ Все валюты пользователя успешно найдены

**4) Тесты шаблонов**

_1\. Тест главного шаблона_

def test_index_template(self):template = self.env.get_template("index.html")  
result = template.render(\*\*self.base_data)  
<br/>\# Проверяем основные элементы  
self.assertIn('Приложение отслеживания курса валют', result)  
self.assertIn('Главная страница', result)  
self.assertIn('Тестовый Автор', result)  
self.assertIn('P3121', result)

_Цель:_ Проверить корректность рендеринга главного шаблона

_Результат:_ Все базовые переменные корректно передаются и отображаются

2\. _Тест шаблона пользователей_

def test_users_template(self):from models import User  
<br/>\# Добавляем тестовых пользователей  
test_data = self.base_data.copy()  
test_data\['users'\] = \[  
User(1, "Иван Иванов"),  
User(2, "Мария Петрова"),  
User(3, "Алексей Сидоров")  
\]  
<br/>template = self.env.get_template("users.html")  
result = template.render(\*\*test_data)  
<br/>\# Проверяем рендеринг списка  
self.assertIn('Иван Иванов', result)  
self.assertIn('Мария Петрова', result)  
self.assertIn('Алексей Сидоров', result)  
self.assertIn('href="/user?id=1"', result)  
self.assertIn('href="/user?id=2"', result)  
self.assertIn('href="/user?id=3"', result)

_Цель:_ Проверить корректную передачу списка пользователей в шаблон

_Результат:_ Все пользователи корректно передаются и отображаются

_3\. Тест передачи переменных в шаблон об авторе_

def test_author_template_variable_passing(self):\# Загружаем шаблон  
template = self.env.get_template("author.html")  
<br/>\# Рендерим шаблон с базовыми данными  
result = template.render(\*\*self.base_data)  
<br/>\# Проверяем вывод информации об авторе  
self.assertIn('Тестовый Автор', result)  
self.assertIn('P3121', result)

_Цель:_ Проверить корректную передачу данных об авторе

_Результат:_ Все данные об авторе корректно передаются и отображаются

**6.2 Результаты тестирования**

**1) Тесты моделей**

Ran 32 tests in 0.028s  
<br/>OK

Все тесты успешно пройдены: модели данных корректно инициализируются, геттеры и сеттеры работают правильно, валидация входных данных выполняется корректно.

**2) Тесты функции**

Ran 11 tests in 0.021s  
<br/>OK

Все тесты успешно пройдены: функция get_currencies корректно взаимодействует с внешним API через мок-объекты. 

**3) Тесты контроллера**

Ran 13 tests in 0.040s  
<br/>OK

Все тесты успешно пройдены: HTTP контроллер корректно обрабатывает различные маршруты через мок-объекты

**4) Тесты шаблонов**

Ran 6 tests in 0.052s  
<br/>OK

Все тесты успешно пройдены: HTML шаблоны корректно рендерятся с передаваемыми переменными. 

1.  **Выводы**

**7.1 Какие проблемы возникли при реализации**

**1. Сложности с маршрутизацией**

- Отсутствие встроенной системы маршрутизации, пришлось реализовывать собственную через if/elif условия
- Проблемы с обработкой некорректных запросов

**2\. Валидация данных в моделях**

- Сложность обеспечения согласованности данных между сеттерами и геттерами
- Необходимость дублирования проверок типов для каждого свойства

**3\. Интеграция Jinja2 с HTTPServer**

- Проблемы с относительными путями при загрузке шаблонов
- Необходимость передачи контекста данных между контроллером и шаблонами

4\. **Тестирование**

- Сложности с мокированием внешних зависимостей (API запросы)
- Проблемы с изоляцией тестов для HTTP обработчика
- Необходимость создания тестовых данных для всех сценариев

**7.2 Как удалось применить принципы MVC**

**Model (Модели)**

- Реализованы классы Author, App, User, Currency, UserCurrency с инкапсуляцией данных
- Использованы свойства (properties) для валидации и контроля доступа
- Реализована связь "многие-ко-многим" через UserCurrency

**View (Представления)**

- Шаблоны Jinja2 в папке templates/ отвечают только за отображение
- Разделение на отдельные шаблоны: index.html, users.html, user.html, currencies.html, author.html

**Controller (Контроллер)**

- SimpleHTTPRequestHandler обрабатывает все HTTP запросы
- Выполняет маршрутизацию на основе self.path

**7.3 Что нового узнали о работе с HTTPServer, Jinja2 и API курсов валют**

**HTTPServer и BaseHTTPRequestHandler**

- Низкоуровневая работа с HTTP: понимание заголовков, кодов состояния, методов запросов
- Ручная маршрутизация: создание собственной системы маршрутизации без фреймворков

**Jinja2 шаблонизатор**

- Инициализация Environment: важность однократной инициализации для производительности
- Наследование шаблонов: создание базовых шаблонов с общими элементами

**API курсов валют**

- Работа с внешними API: отправка HTTP запросов, обработка ответов
- Обработка ошибок: таймауты, сетевые ошибки, некорректные данные

**7.4 Итоговые достижения**

В результате выполнения работы:

1.  Полностью функциональное приложение с пятью маршрутами и динамическим контентом
2.  Четкое разделение на MVC компоненты
3.  Интеграция с реальным API Центробанка России для получения актуальных курсов
4.  Полный набор тестов для всех компонентов приложения
5.  Обработка некорректных данных и сетевых сбоев
